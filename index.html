<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF Tournament Hub | Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700;800&family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neon: '#FFD700',
                        glass: 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        display: ['Oxanium', 'cursive'],
                        serif: ['Playfair Display', 'serif'],
                        inter: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3)',
                    },
                    animation: {
                        'scan': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { top: '0%' },
                            '50%': { top: '100%' },
                            '100%': { top: '0%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 165, 0, 0.1) 0%, transparent 25%);
            overflow-x: hidden;
        }

        /* Live Background Grid Animation */
        .bg-grid {
            position: fixed; top: 0; left: 0; w: 100%; h: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            width: 100vw; height: 100vh; z-index: -1;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            animation: pulseGrid 4s infinite ease-in-out;
        }
        @keyframes pulseGrid { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }
        
        /* Glassmorphism Card with SHINE Effect */
        .glass-card {
            background: rgba(20, 25, 40, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .glass-card::after {
            content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: skewX(-20deg); transition: 0.5s; pointer-events: none;
        }
        .glass-card:hover::after { left: 150%; transition: 0.7s ease-in-out; }
        .glass-card:hover { border-color: rgba(255, 215, 0, 0.4); box-shadow: 0 0 25px rgba(255, 215, 0, 0.15); transform: translateY(-2px); }

        .design-card { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .design-card.selected { border-color: #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); transform: scale(1.02); }

        .gaming-input {
            background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.15); color: #fff; padding: 0.6rem 1rem;
            width: 100%; font-family: 'Oxanium', sans-serif; font-size: 0.9rem; transition: all 0.3s;
        }
        .gaming-input:focus { outline: none; border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); background: rgba(0, 0, 0, 0.8); }

        .btn-gaming {
            background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; font-family: 'Oxanium', sans-serif;
            font-weight: 800; text-transform: uppercase; border: none;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
            transition: all 0.2s;
        }
        .btn-gaming:hover { transform: scale(1.02); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-screen { display: none !important; }
        
        /* Loader */
        #page-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s;
        }
        .loader-bar { width: 200px; height: 4px; background: #222; margin-top: 20px; position: relative; overflow: hidden; }
        .loader-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: #FFD700; animation: load 1s infinite ease-in-out; box-shadow: 0 0 15px #FFD700; }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

        /* Scanning Line */
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #FFD700; box-shadow: 0 0 10px #FFD700;
            top: 0; left: 0; animation: scan 2s linear infinite; z-index: 20;
        }
        
        /* Canvas for Image Processing (Hidden) */
        #processing-canvas { display: none; }

        /* PDF THEMES (Preserved) */
        .theme-neon { background: #000; color: #eee; font-family: 'Rajdhani', sans-serif; border: 1px solid #333; }
        .theme-neon .header { border-bottom: 2px solid #FFD700; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .theme-neon h1 { font-family: 'Oxanium', cursive; color: #fff; text-transform: uppercase; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .theme-neon h3 { color: #FFD700; font-family: 'Oxanium', cursive; text-transform: uppercase; margin-bottom: 0.5rem; border-left: 3px solid #FFD700; padding-left: 10px; }
        .theme-neon table { width: 100%; border-collapse: collapse; font-size: 0.85rem; border: 1px solid #333; }
        .theme-neon th { text-align: left; background: #111; color: #FFD700; padding: 8px; border: 1px solid #333; }
        .theme-neon td { padding: 8px; border: 1px solid #333; }
        .theme-neon .map-box { border: 1px solid #333; background: #111; padding: 5px; text-align: center; color: #FFD700; }
        .theme-neon .accent { color: #FFD700; font-weight: bold; }
        
        .theme-pro { background: #fff; color: #333; font-family: 'Inter', sans-serif; }
        .theme-pro .header { border-bottom: 4px solid #000; padding-bottom: 1.5rem; margin-bottom: 2rem; text-align: center; }
        .theme-pro h1 { font-family: 'Playfair Display', serif; color: #000; font-size: 3rem; margin-bottom: 0; }
        .theme-pro .meta { color: #666; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; }
        .theme-pro h3 { color: #000; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; margin-top: 20px; }
        .theme-pro table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border: 1px solid #ddd; }
        .theme-pro th { background: #f0f0f0; color: #000; padding: 10px; border: 1px solid #ddd; font-weight: bold; }
        .theme-pro td { padding: 10px; border: 1px solid #ddd; color: #333; }
        .theme-pro .map-box { border: 1px solid #ccc; background: #f9f9f9; padding: 5px; text-align: center; color: #333; font-weight: bold; }
        .theme-pro .accent { color: #000; text-decoration: underline; font-weight: bold; }
        .theme-pro .bg-dark { background: #f9f9f9 !important; border: 1px solid #ddd !important; }
        
        .theme-crimson { background: #111; color: #ccc; font-family: 'Rajdhani', sans-serif; border: 4px solid #dc2626; position: relative; }
        .theme-crimson::before { content: "CONFIDENTIAL"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 8rem; color: rgba(220, 38, 38, 0.05); font-weight: 900; z-index: 0; pointer-events: none; }
        .theme-crimson .header { background: #dc2626; color: #000; padding: 1.5rem; margin: -2rem -2rem 2rem -2rem; clip-path: polygon(0 0, 100% 0, 100% 80%, 0 100%); }
        .theme-crimson h1 { font-family: 'Oxanium', cursive; font-weight: 900; font-style: italic; margin: 0; }
        .theme-crimson h3 { color: #dc2626; font-family: 'Oxanium', cursive; text-transform: uppercase; border-left: 5px solid #dc2626; padding-left: 10px; background: rgba(220, 38, 38, 0.1); padding-top: 5px; padding-bottom: 5px; }
        .theme-crimson table { width: 100%; border: 1px solid #333; }
        .theme-crimson th { background: #222; color: #dc2626; text-transform: uppercase; padding: 8px; }
        .theme-crimson td { border-bottom: 1px solid #333; padding: 8px; }
        .theme-crimson .map-box { background: #220000; border: 1px solid #dc2626; color: #ff9999; text-align: center; padding: 5px; }
        .theme-crimson .accent { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="bg-grid"></div>
    
    <canvas id="processing-canvas"></canvas>

    <div id="page-loader" class="hidden-screen">
        <h2 class="text-3xl font-display text-white tracking-widest uppercase animate-pulse">Initializing</h2>
        <div class="loader-bar"></div>
    </div>

    <div id="app-container" class="relative z-10 flex-grow max-w-7xl mx-auto w-full px-4 py-8">

        <!-- STEP 1: LANDING -->
        <div id="step-landing" class="fade-in flex flex-col items-center justify-center min-h-[85vh]">
            <div class="text-center mb-16 relative group">
                 <div class="absolute -inset-10 bg-gradient-to-r from-yellow-500/20 to-orange-600/20 blur-3xl opacity-50 group-hover:opacity-75 transition-opacity duration-1000"></div>
                <div class="relative">
                    <i data-lucide="crosshair" class="w-20 h-20 text-neon mx-auto mb-4 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)]"></i>
                    <h1 class="text-6xl md:text-8xl font-black text-white font-display tracking-tight text-glow">
                        BATTLE<span class="text-neon">HUB</span>
                    </h1>
                    <div class="h-1 w-32 bg-neon mx-auto mt-4 mb-2 shadow-neon"></div>
                    <p class="text-blue-300 font-mono text-sm tracking-[0.3em] uppercase mt-4">Advanced Tournament Engine</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                <button onclick="navigateWithLoader('selection')" class="glass-card p-10 text-left group hover:border-neon transition-all relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><i data-lucide="file-code" class="w-32 h-32 text-neon rotate-12"></i></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-display font-bold text-white group-hover:text-neon mb-2 transition-colors">RULE GENERATOR</h3>
                        <p class="text-gray-400 text-sm mb-4">Detailed rulebooks with 3 unique designs.</p>
                        <span class="text-neon text-xs font-bold uppercase tracking-widest flex items-center gap-2 group-hover:translate-x-2 transition-transform">Initialize <i data-lucide="arrow-right" class="w-4 h-4"></i></span>
                    </div>
                </button>
                <button onclick="navigateWithLoader('evaluator-start')" class="glass-card p-10 text-left group hover:border-blue-500 transition-all relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><i data-lucide="bar-chart-2" class="w-32 h-32 text-blue-500 rotate-12"></i></div>
                    <div class="relative z-10">
                        <h3 class="text-3xl font-display font-bold text-white group-hover:text-blue-400 mb-2 transition-colors">RESULT ENGINE</h3>
                        <p class="text-gray-400 text-sm mb-4">Calculate points via Image or Manual Input.</p>
                        <span class="text-blue-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2 group-hover:translate-x-2 transition-transform">Launch <i data-lucide="arrow-right" class="w-4 h-4"></i></span>
                    </div>
                </button>
            </div>
        </div>

        <!-- ======================= RULEBOOK FLOW ======================= -->

        <!-- STEP 2 (Rules): MODE SELECTION -->
        <div id="step-selection" class="hidden-screen fade-in">
            <button onclick="navigateWithLoader('landing')" class="mb-8 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back</button>
            <h2 class="text-4xl font-display font-bold text-center text-white mb-12 uppercase text-glow">Select Game Mode</h2>
            <div class="flex flex-col md:flex-row justify-center gap-8">
                <div onclick="selectMode('Solo')" class="glass-card p-12 w-full max-w-sm text-center cursor-pointer hover:bg-blue-900/20 transition-all group">
                    <i data-lucide="user" class="w-16 h-16 mx-auto text-blue-400 mb-6"></i>
                    <h3 class="text-3xl font-display font-bold text-white mb-2 group-hover:text-blue-400">SOLO</h3>
                    <p class="text-gray-500 text-sm font-mono tracking-wide">Standard Battle Royale</p>
                </div>
                <div onclick="selectMode('Squad')" class="glass-card p-12 w-full max-w-sm text-center cursor-pointer hover:bg-yellow-900/20 transition-all border-neon/30 group">
                    <i data-lucide="users" class="w-16 h-16 mx-auto text-neon mb-6"></i>
                    <h3 class="text-3xl font-display font-bold text-white mb-2 group-hover:text-neon">SQUAD</h3>
                    <p class="text-gray-500 text-sm font-mono tracking-wide">Competitive Team Mode</p>
                </div>
            </div>
        </div>

        <!-- STEP 3 (Rules): CUSTOMIZE & DESIGN -->
        <div id="step-customize" class="hidden-screen fade-in pb-20">
            <button onclick="navigateWithLoader('selection')" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back</button>
            
            <div class="flex justify-between items-end mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-3xl font-display font-bold text-white">CONFIGURATION</h2>
                <span id="display-mode" class="text-neon font-display text-xl uppercase shadow-neon px-3 py-1 bg-neon/10 border border-neon rounded">Squad</span>
            </div>

            <!-- DESIGN SELECTOR -->
            <div class="mb-10">
                <h3 class="text-white font-display text-lg mb-4 flex items-center gap-2 uppercase tracking-widest"><i data-lucide="palette" class="w-5 h-5 text-neon"></i> Select Design Theme</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="selectTheme('neon')" id="card-neon" class="design-card selected glass-card p-6 relative overflow-hidden group text-center">
                        <div class="h-16 bg-black border border-yellow-500 mb-3 flex items-center justify-center text-yellow-500 font-display uppercase tracking-widest shadow-[0_0_10px_rgba(255,215,0,0.3)]">Neon Cyber</div>
                    </div>
                    <div onclick="selectTheme('pro')" id="card-pro" class="design-card glass-card p-6 relative overflow-hidden group text-center">
                        <div class="h-16 bg-white border border-gray-300 mb-3 flex items-center justify-center text-black font-serif uppercase tracking-widest font-bold">Professional</div>
                    </div>
                    <div onclick="selectTheme('crimson')" id="card-crimson" class="design-card glass-card p-6 relative overflow-hidden group text-center">
                        <div class="h-16 bg-zinc-900 border-2 border-red-600 mb-3 flex items-center justify-center text-red-500 font-display uppercase tracking-widest font-black italic">Crimson Ops</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <!-- Inputs & Settings (Same as previous) -->
                <div class="glass-card p-6">
                    <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2 border-b border-gray-700 pb-2"><i data-lucide="terminal" class="w-4 h-4"></i> Tournament Info</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-gray-500 text-xs block mb-1">Tournament Name</label><input type="text" id="inp-title" class="gaming-input" value="Squad Series Championship"></div>
                            <div><label class="text-gray-500 text-xs block mb-1">Organizer</label><input type="text" id="inp-org" class="gaming-input" value="Official Organizers"></div>
                        </div>
                        <div class="bg-black/30 p-3 rounded border border-gray-700">
                            <label class="text-neon text-xs block mb-2 font-bold uppercase">Round Structure</label>
                            <div class="mb-3"><label class="text-gray-500 text-[10px] block mb-1">Round 1</label><input type="text" id="inp-r1" class="gaming-input text-sm" value="Elimination Round: Top 2 Teams Qualify"></div>
                            <div><label class="text-gray-500 text-[10px] block mb-1">Round 2</label><input type="text" id="inp-r2" class="gaming-input text-sm" value="Point Rush: Best of 3 Maps Wins"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h3 class="text-green-400 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2 border-b border-gray-700 pb-2"><i data-lucide="map" class="w-4 h-4"></i> Map Pool</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-black/40 p-2 rounded hover:bg-white/5 transition-colors"><input type="checkbox" id="map-bermuda" checked class="accent-neon"> <span class="text-sm font-bold">Bermuda</span></label>
                        <label class="flex items-center gap-2 cursor-pointer bg-black/40 p-2 rounded hover:bg-white/5 transition-colors"><input type="checkbox" id="map-kalahari" checked class="accent-neon"> <span class="text-sm font-bold">Kalahari</span></label>
                        <label class="flex items-center gap-2 cursor-pointer bg-black/40 p-2 rounded hover:bg-white/5 transition-colors"><input type="checkbox" id="map-purgatory" checked class="accent-neon"> <span class="text-sm font-bold">Purgatory</span></label>
                        <label class="flex items-center gap-2 cursor-pointer bg-black/40 p-2 rounded hover:bg-white/5 transition-colors"><input type="checkbox" id="map-alpine" class="accent-neon"> <span class="text-sm font-bold">Alpine</span></label>
                    </div>
                    <div><label class="text-gray-500 text-xs block mb-1">Custom Map</label><input type="text" id="inp-custom-map" class="gaming-input" placeholder="e.g. Nexterra"></div>
                </div>

                <div class="glass-card p-6 lg:col-span-2">
                    <h3 class="text-yellow-400 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2 border-b border-gray-700 pb-2"><i data-lucide="sliders" class="w-4 h-4"></i> Game Settings</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div><label class="text-gray-500 text-xs block mb-1">Character Skill</label><select id="inp-skill" class="gaming-input p-1"><option>YES</option><option>NO</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Gun Attr</label><select id="inp-gun" class="gaming-input p-1"><option>NO</option><option>YES</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Ammo</label><select id="inp-ammo" class="gaming-input p-1"><option>Limited</option><option>Unlimited</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Loadout</label><select id="inp-loadout" class="gaming-input p-1"><option>YES</option><option>NO</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Revival</label><select id="inp-revive" class="gaming-input p-1"><option>YES</option><option>NO</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Emulator</label><select id="inp-emu" class="gaming-input p-1"><option>NO</option><option>YES</option></select></div>
                        <div><label class="text-gray-500 text-xs block mb-1">Death Cam</label><select id="inp-death" class="gaming-input p-1"><option>YES</option><option>NO</option></select></div>
                         <div><label class="text-gray-500 text-xs block mb-1">In-Game Mission</label><select id="inp-mission" class="gaming-input p-1"><option>YES</option><option>NO</option></select></div>
                    </div>
                    <div class="bg-black/30 p-3 rounded border border-gray-700 flex gap-2 items-center">
                        <input type="text" id="new-setting-name" class="gaming-input flex-grow" placeholder="Custom Setting (e.g. Fall Damage)">
                        <select id="new-setting-val" class="gaming-input w-24"><option>YES</option><option>NO</option></select>
                        <button onclick="addCustomSetting()" class="btn-gaming px-4 py-1 text-xs font-bold">+ ADD</button>
                    </div>
                    <ul id="custom-settings-list" class="mt-2 space-y-1 text-xs text-gray-300 px-1"></ul>
                </div>

                <div class="glass-card p-6 lg:col-span-2">
                    <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2 border-b border-gray-700 pb-2"><i data-lucide="crosshair" class="w-4 h-4"></i> Point System</h3>
                    <div class="flex items-center gap-4 mb-4 bg-red-900/10 p-3 border border-red-500/20 rounded">
                        <div class="flex-grow"><label class="text-red-300 text-xs block mb-1 font-bold">PER KILL</label><input type="number" id="inp-kill" class="gaming-input text-center font-black text-xl" value="1"></div>
                        <div class="flex-grow"><label class="text-neon text-xs block mb-1 font-bold">BOOYAH (1st)</label><input type="number" id="p1" class="gaming-input text-center font-black text-xl text-neon" value="12"></div>
                    </div>
                    <div class="grid grid-cols-5 gap-2 text-center">
                         <div><label class="text-[10px] text-gray-500">2nd</label><input type="number" id="p2" class="gaming-input text-center p-1" value="9"></div>
                         <div><label class="text-[10px] text-gray-500">3rd</label><input type="number" id="p3" class="gaming-input text-center p-1" value="8"></div>
                         <div><label class="text-[10px] text-gray-500">4th</label><input type="number" id="p4" class="gaming-input text-center p-1" value="7"></div>
                         <div><label class="text-[10px] text-gray-500">5th</label><input type="number" id="p5" class="gaming-input text-center p-1" value="6"></div>
                         <div><label class="text-[10px] text-gray-500">6th</label><input type="number" id="p6" class="gaming-input text-center p-1" value="5"></div>
                         <div><label class="text-[10px] text-gray-500">7th</label><input type="number" id="p7" class="gaming-input text-center p-1" value="4"></div>
                         <div><label class="text-[10px] text-gray-500">8th</label><input type="number" id="p8" class="gaming-input text-center p-1" value="3"></div>
                         <div><label class="text-[10px] text-gray-500">9th</label><input type="number" id="p9" class="gaming-input text-center p-1" value="2"></div>
                         <div><label class="text-[10px] text-gray-500">10th</label><input type="number" id="p10" class="gaming-input text-center p-1" value="1"></div>
                         <div><label class="text-[10px] text-gray-500">11+</label><input type="number" id="p11" class="gaming-input text-center p-1" value="0"></div>
                    </div>
                </div>
            </div>

            <button onclick="generateRules()" class="w-full btn-gaming py-4 text-xl tracking-widest flex items-center justify-center gap-2 shadow-neon hover:shadow-neon/80">
                GENERATE ULTIMATE RULEBOOK <i data-lucide="file-check" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- STEP 4 (Rules): PREVIEW -->
        <div id="step-result" class="hidden-screen fade-in pb-20">
            <div class="flex justify-between items-center mb-6 no-print">
                <button onclick="navigateWithLoader('customize')" class="text-gray-400 hover:text-white uppercase font-bold text-xs flex items-center gap-2 tracking-widest"><i data-lucide="edit-3" class="w-4 h-4"></i> Edit Config</button>
                <button onclick="downloadPDF()" class="btn-gaming px-8 py-2 text-sm flex items-center gap-2 font-bold shadow-neon"><i data-lucide="download" class="w-4 h-4"></i> Save PDF</button>
            </div>
            <div class="overflow-x-auto bg-gray-900/50 p-4 rounded-lg border border-gray-800 backdrop-blur-sm">
                <div id="printable-area" class="theme-neon p-8 md:p-12 min-w-[700px]">
                    <!-- Dynamic Content Injected Here -->
                </div>
            </div>
        </div>

        <!-- ======================= EVALUATOR FLOW ======================= -->

        <!-- STEP A: Evaluator Start (Mode Select) -->
        <div id="step-evaluator-start" class="hidden-screen fade-in">
            <button onclick="navigateWithLoader('landing')" class="mb-8 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back</button>
            <h2 class="text-4xl font-display font-bold text-center text-white mb-12 uppercase text-glow">Result Engine Mode</h2>
            <div class="flex flex-col md:flex-row justify-center gap-8">
                <div onclick="startEvaluator('Solo')" class="glass-card p-12 w-full max-w-sm text-center cursor-pointer hover:bg-blue-900/20 transition-all group">
                    <i data-lucide="user" class="w-16 h-16 mx-auto text-blue-400 mb-6"></i>
                    <h3 class="text-3xl font-display font-bold text-white mb-2">SOLO</h3>
                </div>
                <div onclick="startEvaluator('Squad')" class="glass-card p-12 w-full max-w-sm text-center cursor-pointer hover:bg-yellow-900/20 transition-all border-neon/30 group">
                    <i data-lucide="users" class="w-16 h-16 mx-auto text-neon mb-6"></i>
                    <h3 class="text-3xl font-display font-bold text-white mb-2">SQUAD</h3>
                </div>
            </div>
        </div>

        <!-- STEP B: Input Method -->
        <div id="step-evaluator-method" class="hidden-screen fade-in">
            <button onclick="navigateWithLoader('evaluator-start')" class="mb-8 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back</button>
            <h2 class="text-3xl font-display font-bold text-center text-white mb-12 uppercase">Choose Input Method</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl mx-auto">
                <div onclick="openEvaluatorInput('image')" class="glass-card p-10 text-center cursor-pointer hover:border-neon group">
                    <i data-lucide="camera" class="w-16 h-16 mx-auto text-neon mb-4"></i>
                    <h3 class="text-2xl font-bold text-white mb-2">SCAN SCOREBOARD</h3>
                    <p class="text-gray-400 text-sm">Upload screenshot to auto-extract data.</p>
                </div>
                <div onclick="openEvaluatorInput('manual')" class="glass-card p-10 text-center cursor-pointer hover:border-blue-500 group">
                    <i data-lucide="edit" class="w-16 h-16 mx-auto text-blue-500 mb-4"></i>
                    <h3 class="text-2xl font-bold text-white mb-2">MANUAL ENTRY</h3>
                    <p class="text-gray-400 text-sm">Type kills and rank manually.</p>
                </div>
            </div>
        </div>

        <!-- STEP C: Data Input -->
        <div id="step-evaluator-input" class="hidden-screen fade-in pb-20">
            <button onclick="navigateWithLoader('evaluator-method')" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back</button>
            
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Controls -->
                <div class="lg:w-1/3 space-y-6">
                    <div class="glass-card p-6">
                        <h3 class="text-white font-display font-bold uppercase mb-4 text-sm tracking-widest border-l-2 border-neon pl-2">Point Config</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-xs text-gray-500 block mb-1">Per Kill</label><input type="number" id="calc-kill-pt" class="gaming-input text-center font-bold" value="1"></div>
                            <div><label class="text-xs text-neon block mb-1">#1 Pts</label><input type="number" id="calc-p1" class="gaming-input text-center text-neon font-bold" value="12"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs text-gray-500 block mb-1">#2 Pts</label><input type="number" id="calc-p2" class="gaming-input text-center" value="9"></div>
                            <div><label class="text-xs text-gray-500 block mb-1">#3 Pts</label><input type="number" id="calc-p3" class="gaming-input text-center" value="8"></div>
                        </div>
                    </div>

                    <!-- Image Uploader (Hidden/Visible based on selection) -->
                    <div id="image-upload-area" class="glass-card p-6 text-center border-dashed border-2 border-gray-600 cursor-pointer relative overflow-hidden hidden">
                        <input type="file" id="file-upload" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this)">
                        <div id="upload-label">
                            <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-400 mb-2"></i>
                            <p class="text-sm font-bold text-white">CLICK TO UPLOAD IMAGE</p>
                            <p class="text-xs text-gray-500 mt-1">Supports JPG, PNG</p>
                        </div>
                        <div id="scanning-overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center hidden">
                            <div class="w-full h-full relative">
                                <div class="scan-line"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <p class="text-neon font-display tracking-widest animate-pulse">ANALYZING SCOREBOARD...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6">
                        <button onclick="addTeamRow()" class="w-full bg-gray-800 hover:bg-gray-700 text-white py-2 text-xs font-bold mb-4">+ ADD ROW</button>
                        <button onclick="calculateResults()" class="w-full btn-gaming py-3 tracking-widest font-bold">CALCULATE RESULT</button>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="lg:w-2/3 glass-card p-6 flex flex-col h-[600px]">
                    <div class="grid grid-cols-12 gap-2 text-[10px] text-blue-300 mb-2 uppercase tracking-wider font-bold border-b border-gray-700 pb-2">
                        <div class="col-span-1 text-center">#</div>
                        <div class="col-span-5">Name</div>
                        <div class="col-span-3 text-center">Rank</div>
                        <div class="col-span-3 text-center">Kills</div>
                    </div>
                    <div id="team-input-list" class="space-y-2 overflow-y-auto pr-2 custom-scrollbar flex-grow">
                        <!-- JS Injected -->
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP D: Leaderboard Result -->
        <div id="step-evaluator-result" class="hidden-screen fade-in pb-20">
            <button onclick="navigateWithLoader('evaluator-input')" class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 uppercase font-bold text-xs tracking-widest"><i data-lucide="chevron-left" class="w-4 h-4"></i> Back to Edit</button>
            <div class="glass-card border-neon/30 overflow-hidden">
                <div class="bg-neon/10 p-4 border-b border-neon/20 flex justify-between items-center">
                    <h2 class="text-2xl font-display font-black text-neon uppercase tracking-tight italic">FINAL LEADERBOARD</h2>
                    <i data-lucide="trophy" class="text-neon w-6 h-6 animate-bounce"></i>
                </div>
                <div class="overflow-x-auto bg-black/40 p-4">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase border-b border-gray-800 tracking-widest">
                                <th class="p-4 font-normal">Pos</th>
                                <th class="p-4 font-normal">Team</th>
                                <th class="p-4 font-normal text-center">Rank Pts</th>
                                <th class="p-4 font-normal text-center">Kill Pts</th>
                                <th class="p-4 font-normal text-right">Total Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentMode = 'Squad';
        let currentTheme = 'neon';
        let evalMode = 'Squad';
        let customSettings = [];
        let teamRowCount = 0;
        let steps = ['landing', 'selection', 'customize', 'result', 'evaluator-start', 'evaluator-method', 'evaluator-input', 'evaluator-result'];

        // --- INIT ---
        lucide.createIcons();

        // --- NAVIGATION ---
        function navigateWithLoader(targetStep, callback) {
            const loader = document.getElementById('page-loader');
            loader.classList.remove('hidden-screen');
            setTimeout(() => {
                steps.forEach(s => document.getElementById('step-'+s).classList.add('hidden-screen'));
                if(callback) callback();
                document.getElementById('step-'+targetStep).classList.remove('hidden-screen');
                window.scrollTo(0,0);
                loader.classList.add('hidden-screen');
                lucide.createIcons();
            }, 800);
        }

        // --- RULEBOOK LOGIC ---
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('display-mode').innerText = mode;
            if(mode === 'Solo') {
                document.getElementById('inp-title').value = "Solo Survivor Series";
                document.getElementById('inp-r1').value = "Elimination Round: Top 5 Players Qualify";
                document.getElementById('inp-r2').value = "Clash Squad Finals";
            } else {
                document.getElementById('inp-title').value = "Squad Series Championship";
                document.getElementById('inp-r1').value = "Elimination Round: Top 2 Teams Qualify";
                document.getElementById('inp-r2').value = "Point Rush: Best of 3 Maps";
            }
            navigateWithLoader('customize');
        }

        function selectTheme(theme) {
            currentTheme = theme;
            document.querySelectorAll('.design-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('card-'+theme).classList.add('selected');
        }

        function addCustomSetting() {
            const name = document.getElementById('new-setting-name').value;
            const val = document.getElementById('new-setting-val').value;
            if(name) {
                customSettings.push({name, val});
                const li = document.createElement('li');
                li.innerHTML = `âž¤ ${name}: <span class="font-bold text-white">${val}</span>`;
                document.getElementById('custom-settings-list').appendChild(li);
                document.getElementById('new-setting-name').value = '';
            }
        }

        function generateRules() {
            const container = document.getElementById('printable-area');
            container.className = ''; 
            container.classList.add('theme-' + currentTheme);
            if(currentTheme === 'neon') container.classList.add('p-8', 'md:p-12');
            if(currentTheme === 'pro') container.classList.add('p-12', 'bg-white');
            if(currentTheme === 'crimson') container.classList.add('p-8', 'md:p-12');

            document.getElementById('out-title').innerText = document.getElementById('inp-title').value;
            document.getElementById('out-org').innerText = document.getElementById('inp-org').value + " | OFFICIAL RULEBOOK";
            document.getElementById('out-mode').innerText = currentMode + " MODE";
            document.getElementById('out-r1').innerText = document.getElementById('inp-r1').value;
            document.getElementById('out-r2').innerText = document.getElementById('inp-r2').value;

            const settings = [
                {k: 'Char Skill', v: document.getElementById('inp-skill').value},
                {k: 'Gun Attr', v: document.getElementById('inp-gun').value},
                {k: 'Ammo', v: document.getElementById('inp-ammo').value},
                {k: 'Loadout', v: document.getElementById('inp-loadout').value},
                {k: 'Revival', v: document.getElementById('inp-revive').value},
                {k: 'Emulator', v: document.getElementById('inp-emu').value},
                {k: 'Death Cam', v: document.getElementById('inp-death').value},
                {k: 'Missions', v: document.getElementById('inp-mission').value},
                ...customSettings.map(s => ({k: s.name, v: s.val}))
            ];

            let settingsHTML = '';
            for(let i=0; i<settings.length; i+=2) {
                const s1 = settings[i];
                const s2 = settings[i+1] || {k:'', v:''};
                settingsHTML += `<tr><td style="opacity:0.7">${s1.k}</td><td class="accent">${s1.v}</td><td style="opacity:0.7">${s2.k}</td><td class="accent">${s2.v}</td></tr>`;
            }
            document.getElementById('out-settings-table').innerHTML = settingsHTML;

            const maps = ['bermuda', 'kalahari', 'purgatory', 'alpine'];
            const mapContainer = document.getElementById('out-maps');
            mapContainer.innerHTML = '';
            maps.forEach(m => {
                if(document.getElementById('map-'+m).checked) mapContainer.innerHTML += `<div class="map-box text-[10px] uppercase font-bold">${m}</div>`;
            });
            const customMap = document.getElementById('inp-custom-map').value;
            if(customMap) mapContainer.innerHTML += `<div class="map-box text-[10px] uppercase font-bold">${customMap}</div>`;

            document.getElementById('out-kill').innerText = document.getElementById('inp-kill').value;
            let pointsHTML = '<tr>';
            for(let i=1; i<=4; i++) pointsHTML += `<td>#${i}</td><td class="accent">${document.getElementById('p'+i).value}</td>`;
            pointsHTML += '</tr><tr>';
            for(let i=5; i<=8; i++) pointsHTML += `<td>#${i}</td><td class="accent">${document.getElementById('p'+i).value}</td>`;
            pointsHTML += '</tr><tr>';
            pointsHTML += `<td>#9</td><td class="accent">${document.getElementById('p9').value}</td><td>#10</td><td class="accent">${document.getElementById('p10').value}</td><td>11+</td><td class="accent">${document.getElementById('p11').value}</td><td>-</td><td>-</td></tr>`;
            document.getElementById('out-points-row').innerHTML = pointsHTML;

            navigateWithLoader('result');
        }

        function downloadPDF() {
            const element = document.getElementById('printable-area');
            let bgColor = '#000000';
            if(currentTheme === 'pro') bgColor = '#ffffff';
            if(currentTheme === 'crimson') bgColor = '#111111';
            const opt = { margin: 0.2, filename: `Rulebook.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, backgroundColor: bgColor }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        }

        // --- EVALUATOR LOGIC ---
        function startEvaluator(mode) {
            evalMode = mode;
            navigateWithLoader('evaluator-method');
        }

        function openEvaluatorInput(method) {
            const imgArea = document.getElementById('image-upload-area');
            if(method === 'image') {
                imgArea.classList.remove('hidden');
            } else {
                imgArea.classList.add('hidden');
            }
            // Clear previous data
            document.getElementById('team-input-list').innerHTML = '';
            teamRowCount = 0;
            // Add initial rows
            if(method === 'manual') {
                for(let i=0; i<6; i++) addTeamRow();
            }
            navigateWithLoader('evaluator-input');
        }

        function addTeamRow(name='', rank='', kills='') {
            teamRowCount++;
            const container = document.getElementById('team-input-list');
            const div = document.createElement('div');
            div.className = "grid grid-cols-12 gap-2 fade-in items-center border-b border-gray-800 pb-1 mb-1";
            div.innerHTML = `
                <div class="col-span-1 text-center text-gray-600 font-mono text-[10px]">${teamRowCount}</div>
                <div class="col-span-5"><input type="text" placeholder="TEAM NAME" value="${name}" class="team-name bg-transparent text-white text-xs w-full focus:outline-none uppercase placeholder-gray-700 font-bold font-mono"></div>
                <div class="col-span-3"><input type="number" placeholder="0" value="${rank}" class="team-rank bg-transparent text-neon text-center text-xs w-full focus:outline-none placeholder-gray-800 font-bold"></div>
                <div class="col-span-3"><input type="number" placeholder="0" value="${kills}" class="team-kills bg-transparent text-red-400 text-center text-xs w-full focus:outline-none placeholder-gray-800 font-bold"></div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // REAL OCR IMPLEMENTATION WITH PRE-PROCESSING
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const overlay = document.getElementById('scanning-overlay');
            overlay.classList.remove('hidden');

            try {
                // Pre-process image for better OCR
                const processedImage = await preprocessImage(file);
                
                Tesseract.recognize(
                    processedImage,
                    'eng',
                    { logger: m => console.log(m) }
                ).then(({ data: { text } }) => {
                    overlay.classList.add('hidden');
                    console.log("OCR Result:", text);
                    parseAndPopulate(text);
                    alert("Scan complete! Please verify the numbers.");
                });
            } catch (err) {
                console.error(err);
                overlay.classList.add('hidden');
                alert("Scan failed. Loading Manual Template.");
                simulateScan();
            }
        }

        function preprocessImage(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('processing-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // Simple Binarization (Thresholding)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        const threshold = 100;
                        const color = avg > threshold ? 255 : 0;
                        data[i] = color;
                        data[i + 1] = color;
                        data[i + 2] = color;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL());
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function parseAndPopulate(text) {
            document.getElementById('team-input-list').innerHTML = '';
            teamRowCount = 0;
            const lines = text.split('\n').filter(line => line.trim().length > 3);
            let count = 0;

            lines.forEach(line => {
                let match = line.match(/^(\d+)[.\s]+([A-Za-z0-9\s\-_]+?)\s+(\d+)$/);
                if (!match) {
                    const fallbackMatch = line.match(/^([A-Za-z0-9\s\-_]+?)\s+(\d+)$/);
                    if (fallbackMatch) {
                        match = [null, null, fallbackMatch[1], fallbackMatch[2]];
                    }
                }

                if (match) {
                    const rank = match[1] || (count + 1); 
                    const name = match[2].trim();
                    const kills = match[3];
                    if (isNaN(name) && name.length > 2) {
                        addTeamRow(name, rank, kills);
                        count++;
                    }
                }
            });

            // If OCR returns garbage or empty, use the requested fallback
            if (count < 3) {
                alert("Image unclear. Switched to Manual Template (TEAM ONE, TWO...).");
                simulateScan();
            } else {
                // Pad to minimum 5 rows
                while(count < 5) { addTeamRow(); count++; }
            }
        }

        // UPDATED FALLBACK: GENERIC NAMES & 0 KILLS
        function simulateScan() {
            document.getElementById('team-input-list').innerHTML = '';
            teamRowCount = 0;
            const numberWords = ["ONE", "TWO", "THREE", "FOUR", "FIVE", "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "ELEVEN", "TWELVE"];
            
            for(let i=0; i<12; i++) {
                // Names: TEAM ONE...
                // Rank: Auto 1-12
                // Kills: 0 (Manual entry required)
                addTeamRow(`TEAM ${numberWords[i]}`, i+1, 0);
            }
        }

        function calculateResults() {
            const killPt = parseInt(document.getElementById('calc-kill-pt').value) || 1;
            const standardPoints = { 1: 12, 2: 9, 3: 8, 4: 7, 5: 6, 6: 5, 7: 4, 8: 3, 9: 2, 10: 1 };

            let teams = [];
            const names = document.querySelectorAll('.team-name');
            const ranks = document.querySelectorAll('.team-rank');
            const kills = document.querySelectorAll('.team-kills');

            for (let i = 0; i < names.length; i++) {
                if(names[i].value.trim() !== "") {
                    let rank = parseInt(ranks[i].value) || 12;
                    let killCount = parseInt(kills[i].value) || 0;
                    let placePts = standardPoints[rank] || 0;
                    let killPts = killCount * killPt;
                    teams.push({
                        name: names[i].value,
                        rank: rank,
                        placePts: placePts,
                        killPts: killPts,
                        total: placePts + killPts
                    });
                }
            }

            teams.sort((a, b) => b.total - a.total);

            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            teams.forEach((t, index) => {
                let rowStyle = "";
                let rankText = `#${index + 1}`;
                if(index === 0) {
                    rowStyle = "bg-neon/20 text-white border-l-4 border-neon";
                    rankText = `<i data-lucide="crown" class="w-4 h-4 text-neon inline mr-1"></i>`;
                } else if(index < 3) {
                     rowStyle = "text-white bg-white/5 border-l-4 border-blue-500";
                } else {
                    rowStyle = "text-gray-500 hover:bg-white/5 border-l-4 border-transparent";
                }

                tbody.innerHTML += `
                    <tr class="${rowStyle} border-b border-gray-800 transition-colors">
                        <td class="p-4 font-mono text-xs">${rankText}</td>
                        <td class="p-4 font-bold uppercase text-xs tracking-wider font-display">${t.name} <span class="text-[9px] text-gray-500 ml-2 font-mono">Rank #${t.rank}</span></td>
                        <td class="p-4 text-center text-gray-500 font-mono text-xs">${t.placePts}</td>
                        <td class="p-4 text-center text-gray-500 font-mono text-xs">${t.killPts}</td>
                        <td class="p-4 text-right font-black text-lg font-display text-white">${t.total}</td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
            navigateWithLoader('evaluator-result');
        }
    </script>
</body>
</html>
